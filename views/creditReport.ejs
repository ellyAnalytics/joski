<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Credit Sales Report</title>
  <!-- Bootstrap 5 -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .table th {
      background-color: #0d6efd;
      color: white;
    }
    .badge {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>



<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
  <%- include('navbar') %>
  <a href="/dashboard" class="text-decoration-none fw-bold" style="color: #0a3679;">
    <i class="bi bi-arrow-left-circle-fill" style="color: goldenrod; font-size: 1.3rem; vertical-align: middle;"></i>
    <span class="ms-1" style="color: #04265a;">Back to Dashboard</span>
  </a>
  </div>

 

  <div class="container-fluid py-5">
    <div class="row justify-content-center">

      <div class="col-lg-30">
        <div class="card p-4">
          <h3 class="text-center mb-4 text-primary">Credit Sales Report</h3>
          
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
              <thead>
                <tr class="text-center">
                  <th>Invoice No</th>
                  <th>Customer</th>
                  <th>Phone</th>
                  <th>National ID</th>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Total</th>
                  <th>Paid</th>
                  <th>Balance</th>
                  <th>Payment Mode</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% if (credits.length > 0) { %>
                  <% credits.forEach(credit => { %>
                    <tr class="text-center">
                    <td><%= credit.invoiceNo %></td>
                    <td><%= credit.customerName %></td>
                    <td><%= credit.phone %></td>
                    <td><%= credit.nationalID %></td>
                    <td><%= credit.productName %> (<%= credit.productCode %>)</td> <!-- ✅ Product here -->
                    <td><%= credit.qty %></td>
                    <td>Ksh <%= credit.total %></td>
                    <td>Ksh <%= credit.paid %></td>
                    <td>
                        <% let balance = credit.total - credit.paid; %>
                        <span class="fw-bold <%= balance > 0 ? 'text-danger' : 'text-success' %>">
                        Ksh <%= balance %>
                        </span>
                    </td>
                    <td><%= credit.paymentMode %></td>
                    <td>
                        <% if (credit.paid >= credit.total) { %>
                        <span class="badge bg-success">Cleared</span>
                        <% } else if (credit.paid > 0) { %>
                        <span class="badge bg-warning text-dark">Partial</span>
                        <% } else { %>
                        <span class="badge bg-danger">Unpaid</span>
                        <% } %>
                    </td>
                    <td>
                    <!-- Add Payment -->
                      <form action="/credit/pay/<%= credit.id %>" method="POST" class="d-inline">
                        <input type="number" name="amount" min="1" class="form-control form-control-sm d-inline w-auto" 
                              placeholder="Amount" required>
                        <button type="submit" class="btn btn-sm btn-warning">Add Payment</button>
                      </form>

                      <!-- Settle only if balance exists -->
                      <% if (credit.paid < credit.total) { %>
                        <a href="/credit/settle/<%= credit.id %>" class="btn btn-sm btn-success">Settle</a>
                      <% } %>

                      <!-- Delete -->
                  <form action="/credit/delete/<%= credit.id %>" method="POST" class="d-inline"
                       onsubmit="return confirm('Are you sure you want to delete this credit and restore stock?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                 </form>

                  <button class="btn btn-info btn-sm print-btn"
                    data-credit='<%- JSON.stringify(credit) %>'>
                    <i class="bi bi-printer"></i> Print
                  </button>
                    </td>

                    </tr>

                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="12" class="text-center text-muted">No credit records found</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between mt-3">
            <a href="/credit" class="btn btn-outline-primary">Add New Credit</a>
            <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.querySelectorAll(".print-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const c = JSON.parse(btn.dataset.credit);
    printCreditReceipt(c);
  });
});

function printCreditReceipt(c) {
  const printWindow = window.open("", "PRINT", "width=256,height=600,top=100,left=100,scrollbars=no,toolbar=no,location=no,titlebar=no,status=no,menubar=no");

 // Calculate "to be paid before" date (10 days from today)
  let dueDate = new Date();
  dueDate.setDate(dueDate.getDate() + 30);
  const dueDateStr = dueDate.getDate().toString().padStart(2, '0') + "/" +
                   (dueDate.getMonth() + 1).toString().padStart(2, '0') + "/" +
                   dueDate.getFullYear();

  let content = `
    <html>
      <head>
        <title>Credit Receipt</title>
        <style>
          body {
            font-family: monospace;
            font-size: 12px;
            width: 66mm;
            
          }
          @page {
            size: 66mm auto;   /* ✅ lock width to thermal roll */
            margin: 0;         /* ✅ remove browser margins */
          }


          .center { text-align: center; }
          .right { text-align: right; }
          .line { border-top: 1px dashed #000; margin: 4px 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 5px; }
          td { padding: 2px 0; }
        </style>
      </head>
      <body>
        <div class="center">
          <strong>JOSKI AND SONS STORES</strong><br/>
          Tel: 0792 928 876<br/>
          KRA PIN: A008950002K<br/>
        </div>
        <div class="line"></div>
        <p>Invoice No: ${c.invoiceNo}<br/>
        Date: ${new Date().getDate().toString().padStart(2, '0')}/${
          (new Date().getMonth() + 1).toString().padStart(2, '0')}/${
          new Date().getFullYear()}<br/>
        Time: ${new Date().toLocaleTimeString()}<br/>
        <strong>To be paid before:</strong> ${dueDateStr}
        </p>
        <p><strong>Customer:</strong> ${c.customerName}<br/>
        <strong>Phone:</strong> ${c.phone}<br/>
        <strong>ID:</strong> ${c.nationalID}</p>
        <div class="line"></div>
        <table>
          <tr>
            <td>Item</td>
            <td class="right">Qty</td>
            <td class="right">Price</td>
          </tr>
          <tr>
            <td>${c.productName}</td>
            <td class="right">${c.qty}</td>
            <td class="right">Ksh. ${Number(c.total).toLocaleString()}</td>
          </tr>
        </table>
        <div class="line"></div>
        <table>
          <tr><td>Total</td><td class="right">Ksh. ${Number(c.total).toLocaleString()}</td></tr>
          <tr><td>Paid</td><td class="right">Ksh. ${Number(c.paid).toLocaleString()}</td></tr>
          <tr><td>Balance</td><td class="right">Ksh. ${(c.total - c.paid).toLocaleString()}</td></tr>
          <tr><td>Mode</td><td class="right">${c.paymentMode}</td></tr>
        </table>
        <div class="line"></div>
        <p class="center">Thank you for shopping with us.<br/>
        Welcome again.<br/>
        Goods remain property of Joski and Sons Stores until fully paid.<br/>
        Delayed payments after 30 days<br/> attract 10% interest.</p>
      </body>
    </html>
  `;
printWindow.document.write(content);
printWindow.document.close();

printWindow.focus();
printWindow.print();
printWindow.onafterprint = () => {
  printWindow.close();
};

}
</script>




  <!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
